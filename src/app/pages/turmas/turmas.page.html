<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button *ngIf="selectedTurma" (click)="backToList()" fill="clear" class="custom-back-btn">
        <ion-icon slot="icon-only" name="chevron-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-buttons slot="start" *ngIf="!selectedTurma">
      <ion-menu-button class="menu-button-externo"></ion-menu-button>
    </ion-buttons>
    <ion-title>{{ selectedTurma ? 'Turma ' + selectedTurma.id : 'Turmas' }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="container">
    <div *ngIf="!selectedTurma">
      <!-- Search Section -->
      <div class="search-section">
        <div class="search-input-wrapper">
          <ion-icon name="search-outline" class="search-icon"></ion-icon>
          <input 
            placeholder="Pesquisar turma..." 
            [(ngModel)]="query" 
            class="search-input"
          />
        </div>
      </div>

      <!-- Turmas Grid -->
      <div class="grid">
        <div class="card" *ngFor="let t of filteredTurmas()" (click)="selectTurma(t)">
          <div class="card-content">
            <div class="avatar">üë•</div>
            <div class="turma-id">{{ t.id }}</div>
            <div class="turma-label">Turma</div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="filteredTurmas().length === 0">
        <ion-icon name="school-outline" class="empty-icon"></ion-icon>
        <h3>Nenhuma turma encontrada</h3>
        <p>Tente alterar os termos da pesquisa</p>
      </div>
    </div>

    <!-- Turma Details -->
    <div *ngIf="selectedTurma">
      <!-- Header -->
      <div class="turma-header">
        <div class="turma-info">
          <h1 class="turma-title">Turma {{ selectedTurma.id }}</h1>
          <div class="students-count">{{ studentsByTurma[selectedTurma.id]?.length || 0 }} alunos</div>
        </div>
        <div class="header-actions">
          <button class="edit-btn" (click)="editarNomeTurma()">
            <ion-icon name="create-outline"></ion-icon>
            Editar
          </button>
          <button class="delete-btn" (click)="abrirModalExcluir()">
            <ion-icon name="trash-outline"></ion-icon>
            Excluir
          </button>
        </div>
      </div>

      <!-- Students Search -->
      <div class="search-section">
        <div class="search-input-wrapper">
          <ion-icon name="search-outline" class="search-icon"></ion-icon>
          <input placeholder="Pesquisar aluno..." class="search-input" />
        </div>
      </div>

      <!-- Students Grid -->
      <div class="grid students-grid">
        <div class="card student-card" *ngFor="let s of studentsByTurma[selectedTurma.id]">
          <div (click)="abrirRegistroAluno(s)" style="flex: 1; display: flex; align-items: center; gap: 12px;">
            <div class="student-avatar">
              <img [src]="s.avatar" class="avatar-img" />
              <div class="presence-indicator" [class.present]="!s.falta"></div>
            </div>
            <div class="student-info">
              <div class="student-name">{{ s.name }}</div>
              <div class="student-id">{{ s.id }}</div>
            </div>
          </div>
          <button class="remove-student-btn" (click)="removerAluno(s); $event.stopPropagation()">
            <ion-icon name="close-circle-outline"></ion-icon>
          </button>
        </div>
      </div>

      <!-- Add Student Button -->
      <button class="add-student-btn" (click)="abrirAdicionarAluno()">
        <ion-icon name="add-circle-outline"></ion-icon>
        Adicionar Aluno
      </button>
    </div>

    <!-- Edit Turma Modal -->
    <div class="modal-overlay" *ngIf="showEditModal" (click)="fecharModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Editar Nome da Turma</h3>
          <button class="close-btn" (click)="fecharModal()">
            <ion-icon name="close-outline"></ion-icon>
          </button>
        </div>
        <div class="modal-body">
          <div class="input-wrapper">
            <label>Nome da Turma</label>
            <input type="text" [(ngModel)]="novoNomeTurma" placeholder="Digite o novo nome" class="modal-input" />
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-secondary" (click)="fecharModal()">Cancelar</button>
          <button class="btn btn-primary" (click)="salvarNomeTurma()">Salvar Altera√ß√µes</button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" *ngIf="showDeleteModal" (click)="fecharModalExcluir()">
      <div class="modal-content modal-delete" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Confirmar Exclus√£o</h3>
          <button class="close-btn" (click)="fecharModalExcluir()">
            <ion-icon name="close-outline"></ion-icon>
          </button>
        </div>
        <div class="modal-body">
          <p class="delete-message">Voc√™ realmente deseja apagar esta turma?</p>
        </div>
        <div class="modal-actions">
          <button class="btn btn-secondary" (click)="fecharModalExcluir()">Cancelar</button>
          <button class="btn btn-danger" (click)="confirmarExcluirTurma()">Excluir</button>
        </div>
      </div>
    </div>

    <!-- Add Student Modal -->
    <div class="modal-overlay" *ngIf="showAddAlunoModal" (click)="fecharAddAlunoModal()">
      <div class="modal-content modal-add-aluno" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Adicionar Aluno</h3>
          <button class="close-btn" (click)="fecharAddAlunoModal()">
            <ion-icon name="close-outline"></ion-icon>
          </button>
        </div>
        <div class="modal-body">
          <div class="search-section">
            <div class="search-input-wrapper">
              <ion-icon name="search-outline" class="search-icon"></ion-icon>
              <input 
                placeholder="Buscar aluno por nome ou matr√≠cula..." 
                [(ngModel)]="searchAluno" 
                class="search-input"
              />
            </div>
          </div>
          <div class="alunos-list">
            <div class="aluno-item" *ngFor="let aluno of filteredAlunosDisponiveis()" (click)="adicionarAluno(aluno)">
              <div class="aluno-info">
                <div class="aluno-name">{{ aluno.nome }}</div>
                <div class="aluno-matricula">Matr√≠cula: {{ aluno.matricula }}</div>
              </div>
              <ion-icon name="add-circle-outline" class="add-icon"></ion-icon>
            </div>
            <div class="empty-state" *ngIf="filteredAlunosDisponiveis().length === 0">
              <p>Nenhum aluno encontrado</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Student Details Modal -->
    <div class="modal-overlay" *ngIf="showAlunoModal" (click)="fecharAlunoModal()">
      <div class="modal-content modal-aluno" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ alunoSelecionado?.name }}</h3>
          <button class="close-btn" (click)="fecharAlunoModal()">
            <ion-icon name="close-outline"></ion-icon>
          </button>
        </div>
        <div class="modal-body">
          <div class="student-profile">
            <img [src]="alunoSelecionado?.avatar" class="profile-avatar" />
            <div class="profile-info">
              <div class="profile-name">{{ alunoSelecionado?.name }}</div>
              <div class="profile-id">{{ alunoSelecionado?.id }}</div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-group">
              <label>Alimenta√ß√£o</label>
              <select [(ngModel)]="alunoSelecionado.alimentacao" class="form-select">
                <option value="√ìtimo">√ìtimo</option>
                <option value="Bom">Bom</option>
                <option value="Regular">Regular</option>
                <option value="Ruim">Ruim</option>
              </select>
            </div>

            <div class="form-group">
              <label>Comportamento</label>
              <select [(ngModel)]="alunoSelecionado.comportamento" class="form-select">
                <option value="√ìtimo">√ìtimo</option>
                <option value="Bom">Bom</option>
                <option value="Regular">Regular</option>
                <option value="Ruim">Ruim</option>
              </select>
            </div>

            <div class="form-group">
              <label>Presen√ßa</label>
              <select [(ngModel)]="alunoSelecionado.presenca" class="form-select">
                <option value="Presente">Presente</option>
                <option value="Ausente">Ausente</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-secondary" (click)="fecharAlunoModal()">Cancelar</button>
          <button class="btn btn-primary" (click)="salvarRegistroAluno()">Salvar Registro</button>
        </div>
      </div>
    </div>
  </div>
</ion-content>