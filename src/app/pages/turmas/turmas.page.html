<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button *ngIf="selectedTurma" (click)="backToList()" fill="clear" class="custom-back-btn">
        <ion-icon slot="icon-only" name="chevron-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-buttons slot="start" *ngIf="!selectedTurma">
      <ion-menu-button class="menu-button-externo"></ion-menu-button>
    </ion-buttons>
    <ion-title></ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="container">
    <div *ngIf="!selectedTurma">
      <!-- Search Section -->
      <div class="search-section">
        <div class="search-input-wrapper">
          <ion-icon name="search-outline" class="search-icon"></ion-icon>
          <input 
            placeholder="Pesquisar turma..." 
            [(ngModel)]="query" 
            class="search-input"
          />
        </div>
      </div>

      <!-- Turmas Grid -->
      <div class="grid">
        <div class="card" *ngFor="let t of filteredTurmas()" (click)="selectTurma(t)">
          <div class="card-content">
            <div class="turma-avatar">
              <div class="avatar" *ngIf="!t.foto || t.foto === 'assets/img/avatar.jpg'">ðŸ‘¥</div>
              <img *ngIf="t.foto && t.foto !== 'assets/img/avatar.jpg'" [src]="t.foto" class="turma-foto" alt="Foto da turma">
            </div>
            <div class="turma-info">
              <div class="turma-nome-linha">
                <span class="turma-nome-label">Nome da turma:</span>
                <span class="turma-id">{{ t.nome }}</span>
              </div>
              <div class="turma-ano-linha">
                <span class="turma-ano-label">Ano da Turma:</span>
                <span class="turma-ano">{{ t.ano }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="filteredTurmas().length === 0">
        <ion-icon name="school-outline" class="empty-icon"></ion-icon>
        <h3>Nenhuma turma encontrada</h3>
        <p>Tente alterar os termos da pesquisa</p>
      </div>

      <!-- Add Turma Button (Docentes only) -->
      <button class="add-turma-btn" *ngIf="isDocente" (click)="abrirAdicionarTurma()">
        <ion-icon name="add-circle-outline"></ion-icon>
        Adicionar Turma
      </button>
    </div>

    <!-- Turma Details -->
    <div *ngIf="selectedTurma">
      <!-- Header -->
      <div class="turma-header">
        <div class="turma-info">
          <h1 class="turma-title">{{ selectedTurma.nome }}</h1>
          <div class="students-count">{{ (studentsByTurma[selectedTurma.id] || []).length }} alunos</div>
        </div>
        <div class="header-actions">
          <button class="edit-btn" (click)="editarNomeTurma()">
            <ion-icon name="create-outline"></ion-icon>
            Editar
          </button>
          <button class="delete-btn" (click)="abrirModalExcluir()">
            <ion-icon name="trash-outline"></ion-icon>
            Excluir
          </button>
        </div>
      </div>

      <!-- Students Search -->
      <div class="search-section">
        <div class="search-input-wrapper">
          <ion-icon name="search-outline" class="search-icon"></ion-icon>
          <input placeholder="Pesquisar aluno..." class="search-input" />
        </div>
      </div>

      <!-- Students Grid -->
      <div class="grid students-grid">
        <div class="card student-card" *ngFor="let s of getAlunosOrdenados(selectedTurma.id)">
          <div class="contador-card">{{ s.contador }}</div>
          <div (click)="abrirRegistroAluno(s)" style="flex: 1; display: flex; align-items: center; gap: 12px;">
            <div class="student-avatar">
              <img [src]="s.avatar" class="avatar-img" />
              <div class="presence-indicator" [class.present]="!s.falta"></div>
            </div>
            <div class="student-info">
              <div class="student-nome-linha">
                <span class="student-nome-label">Nome:</span>
                <span class="student-name">{{ s.name }}</span>
              </div>
              <div class="student-id-linha">
                <span class="student-id-label">MatrÃ­cula:</span>
                <span class="student-id">{{ s.id }}</span>
              </div>
            </div>
          </div>
          <button class="remove-student-btn" (click)="abrirModalRemover(s); $event.stopPropagation()">
            âœ•
          </button>
        </div>
      </div>

      <!-- Add Student Button -->
      <button class="add-student-btn" (click)="abrirAdicionarAluno()">
        <ion-icon name="add-circle-outline"></ion-icon>
        Adicionar Aluno
      </button>
    </div>

    <!-- Edit Turma Modal -->
    <div class="modal-overlay" *ngIf="showEditModal" (click)="fecharModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Editar InformaÃ§Ãµes da Turma</h3>
          <button class="close-btn" (click)="fecharModal()">
            <ion-icon name="close-outline"></ion-icon>
          </button>
        </div>
        <div class="modal-body">
          <div class="input-wrapper">
            <label>Nome da Turma</label>
            <input type="text" [(ngModel)]="novoNomeTurma" placeholder="Digite o novo nome" class="modal-input" />
          </div>
          <div class="foto-section">
            <label>Foto da Turma</label>
            <div class="foto-wrapper">
              <div class="foto-container" (click)="selectTurmaImage()">
                <img [src]="turmaImage || 'assets/img/avatar.jpg'" alt="Foto da turma">
              </div>
              <ion-button fill="clear" class="change-photo-btn" (click)="selectTurmaImage()">
                <ion-icon name="camera"></ion-icon>
              </ion-button>
            </div>
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-primary" (click)="salvarNomeTurma()">Salvar</button>
          <button class="btn btn-secondary" (click)="fecharModal()">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" *ngIf="showDeleteModal" (click)="fecharModalExcluir()">
      <div class="modal-content modal-delete" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Confirmar ExclusÃ£o</h3>
          <button class="close-btn" (click)="fecharModalExcluir()">
            <ion-icon name="close-outline"></ion-icon>
          </button>
        </div>
        <div class="modal-body">
          <p class="delete-message">VocÃª realmente deseja apagar esta turma?</p>
        </div>
        <div class="modal-actions">
          <button class="btn btn-danger" (click)="confirmarExcluirTurma()">Excluir</button>
          <button class="btn btn-secondary" (click)="fecharModalExcluir()">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Add Student Modal -->
    <div class="modal-overlay" *ngIf="showAddAlunoModal" (click)="fecharAddAlunoModal()">
      <div class="modal-content modal-add-aluno" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Adicionar Aluno</h3>
          <button class="close-btn" (click)="fecharAddAlunoModal()">
            <ion-icon name="close-outline"></ion-icon>
          </button>
        </div>
        <div class="modal-body">
          <div class="search-section">
            <div class="search-input-wrapper">
              <ion-icon name="search-outline" class="search-icon"></ion-icon>
              <input 
                placeholder="Buscar aluno por nome ou matrÃ­cula..." 
                [(ngModel)]="searchAluno" 
                class="search-input"
              />
            </div>
          </div>
          <div class="alunos-list">
            <div class="aluno-item" *ngFor="let aluno of filteredAlunosDisponiveis()" (click)="adicionarAluno(aluno)">
              <div class="aluno-info">
                <div class="aluno-name">{{ aluno.nome }}</div>
                <div class="aluno-matricula">MatrÃ­cula: {{ aluno.matricula }}</div>
              </div>
              <ion-icon name="add-circle-outline" class="add-icon"></ion-icon>
            </div>
            <div class="empty-state" *ngIf="filteredAlunosDisponiveis().length === 0">
              <p>Nenhum aluno encontrado</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Remove Student Modal -->
    <div class="modal-overlay" *ngIf="showRemoveModal" (click)="fecharModalRemover()">
      <div class="modal-content modal-delete" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Remover Aluno</h3>
          <button class="close-btn" (click)="fecharModalRemover()">
            <ion-icon name="close-outline"></ion-icon>
          </button>
        </div>
        <div class="modal-body">
          <p class="delete-message">VocÃª realmente deseja tirÃ¡-lo da turma?</p>
        </div>
        <div class="modal-actions">
          <button class="btn btn-danger" (click)="confirmarRemoverAluno()">Remover</button>
          <button class="btn btn-secondary" (click)="fecharModalRemover()">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Add Turma Modal -->
    <div class="modal-overlay" *ngIf="showAddTurmaModal" (click)="fecharAddTurmaModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Adicionar Turma</h3>
          <button class="close-btn" (click)="fecharAddTurmaModal()">
            <ion-icon name="close-outline"></ion-icon>
          </button>
        </div>
        <div class="modal-body">
          <div class="input-wrapper">
            <label>Nome da Turma</label>
            <input type="text" [(ngModel)]="novaTurmaNome" placeholder="Ex: Turma A" class="modal-input" />
          </div>
          <div class="input-wrapper">
            <label>Ano</label>
            <input type="text" [(ngModel)]="novaTurmaAno" placeholder="Ex: 2024" class="modal-input" />
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-primary" (click)="salvarNovaTurma()">Adicionar</button>
          <button class="btn btn-secondary" (click)="fecharAddTurmaModal()">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Student Details Modal -->
    <div class="modal-overlay" *ngIf="showAlunoModal" (click)="fecharAlunoModal()">
      <div class="modal-content modal-aluno" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ alunoSelecionado?.name }}</h3>
          <div class="contador-badge" *ngIf="alunoSelecionado?.contador">{{ alunoSelecionado.contador }}</div>
          <button class="close-btn" (click)="fecharAlunoModal()">
            <ion-icon name="close-outline"></ion-icon>
          </button>
        </div>
        <div class="modal-body">
          <div class="student-profile">
            <img [src]="alunoSelecionado?.avatar" class="profile-avatar" />
            <div class="profile-info">
              <div class="profile-name">{{ alunoSelecionado?.name }}</div>
              <div class="profile-id">{{ alunoSelecionado?.id }}</div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-group">
              <label>AlimentaÃ§Ã£o</label>
              <select [(ngModel)]="alunoSelecionado.alimentacao" class="form-select">
                <option value="" disabled selected>â€” Selecione â€”</option>
                <option value="Ã“timo">Ã“timo</option>
                <option value="Bom">Bom</option>
                <option value="Regular">Regular</option>
                <option value="Ruim">Ruim</option>
              </select>
            </div>

            <div class="form-group">
              <label>Comportamento</label>
              <select [(ngModel)]="alunoSelecionado.comportamento" class="form-select">
                <option value="" disabled selected>â€” Selecione â€”</option>
                <option value="Ã“timo">Ã“timo</option>
                <option value="Bom">Bom</option>
                <option value="Regular">Regular</option>
                <option value="Ruim">Ruim</option>
              </select>
            </div>

            <div class="form-group">
              <label>PresenÃ§a</label>
              <select [(ngModel)]="alunoSelecionado.presenca" class="form-select">
                <option value="" disabled selected>â€” Selecione â€”</option>
                <option value="Presente">Presente</option>
                <option value="Ausente">Ausente</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-success" (click)="salvarRegistroAluno()">Salvar Registro</button>
          <button class="btn btn-secondary" (click)="fecharAlunoModal()">Cancelar</button>
        </div>
      </div>
    </div>
  </div>
</ion-content>